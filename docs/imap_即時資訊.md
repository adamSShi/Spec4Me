# 🧩 新北 iMAP 系統需求與設計文件（工程導向最終版）

---

## 📘 1. 文件基本資訊

| 項目 | 內容 |
|------|------|
| 文件名稱 | 新北 iMAP 系統功能模組需求與設計說明 |
| 文件版本 | v1.0.0 |
| 更新日期 | 2025/10/17 |
| 編寫者 | 開發組（SA 負責人: XXX） |
| 資料來源 | CPJ25007_新北系統維運案_需求管控表、需求訪談紀錄 |
| 適用系統 | 新北 iMAP |
| 關鍵標籤 | #地圖呈現 #圖文連動 #鄰近資訊 #查詢邏輯 #介接資料來源 |

---

## 🧭 2. 功能概要

### 2.1 系統目的

本系統提供新北市地圖式資訊查詢平台，整合多項即時與靜態資料（天氣、停車、YouBike、學區、公告地價等），  
以「地圖 + 資料卡」的方式呈現，提升使用者在地資訊查詢體驗。

### 2.2 功能清單（模組化）

| 功能編號 | 功能名稱 | 版型 | 查詢邏輯 | 狀態 |
|-----------|-----------|-------|------------|--------|
| F01 | 天氣資訊 | A | 點位查詢（Point-in-Polygon） | ✅ 完成 |
| F02 | 所屬學區 | A | 點位查詢（PIP） | 🟡 進行中 |
| F03 | 公告現值 | A | 點位查詢（PIP） | ✅ 完成 |
| F04 | 都市計畫範圍 | A | 交集判斷（Intersect） | 🟡 進行中 |
| F05 | 轄區警局 | A | 門牌對應（Address-to-District） | 🟡 進行中 |
| F06 | YouBike | B | 環域查詢（Buffer 1KM） | ✅ 完成 |
| F07 | 停車資訊 | B | 環域查詢（Buffer 1KM） | 🟡 進行中 |
| F08 | 活動地圖 | B | 環域查詢（Buffer 1KM） | 🟡 進行中 |
| F09 | Wifi 熱點 | C | 點位查詢 | 🟢 已規劃 |
| F10 | AED 資訊 | C | 點位查詢 | 🟢 已規劃 |

---

## ⚙️ 3. 系統行為與操作邏輯

### 3.1 操作通則（共用互動邏輯）

| 事件 | 條件 | 行為 | 結果 |
|------|------|------|------|
| 點擊功能按鈕 | 功能未開啟 | 開啟該功能模組、查詢資料、顯示圖卡 | 顯示結果於地圖與圖卡 |
| 點擊功能按鈕（第二次） | 功能已開啟 | 收合圖卡、清除地圖圖徵 | 回復初始狀態 |
| 點擊 X（關閉鍵） | 任意狀態 | 關閉功能模組並清除資料 | 所有圖徵與圖卡消失 |
| 點擊地圖圖徵 | 資料存在 | 顯示詳細資訊 | 開啟字卡內容 |
| 資料逾時或異常 | 任意 | 顯示錯誤提示 icon | 禁止操作 |

### 3.2 版型差異說明

| 版型 | 適用功能 | 顯示方式 | 特殊互動邏輯 |
|------|------------|------------|----------------|
| A | 天氣資訊、學區、公告現值、都市計畫、轄區警局 | 單一字卡顯示於畫面上方 | 第二次點擊會清除圖層與字卡 |
| B | YouBike、停車、活動地圖 | 提供查詢清單與距離排序 | 第二次點擊僅收合清單，保留圖層 |
| C | Wifi 熱點、AED | 僅顯示點位圖徵與字卡 | 沒有列表搜尋功能 |

---

## 🌦️ 4. 功能詳細規格（以 F01 天氣資訊為例）

### 4.1 功能說明

使用者於地圖上點擊任一點位後，系統依該點位所在行政區查詢天氣資料，  
顯示「溫度、天氣、降雨機率、紫外線、空氣品質」資訊於圖卡上。

---

### 4.2 操作流程（互動邏輯）

| 步驟 | 操作 | 系統行為 |
|------|------|-----------|
| 1 | 使用者點擊地圖位置 | 取得經緯度座標 |
| 2 | 系統判斷該點所在行政區（TownCode） | 執行 `pointInPolygon()` |
| 3 | 系統呼叫氣象署 API | 查詢對應行政區當前天氣資訊 |
| 4 | 回傳資料後顯示字卡 | 顯示溫度、天氣、降雨機率、紫外線、空氣品質 |
| 5 | 若使用者再次點擊天氣圖示 | 清除圖徵與字卡 |

---

### 4.3 查詢邏輯與資料流

```mermaid
flowchart TD
    A[使用者點擊地圖] --> B[取得座標]
    B --> C[比對行政區 Polygon]
    C --> D[呼叫氣象署 API]
    D --> E[解析 XML → JSON]
    E --> F[產生字卡內容]
    F --> G[顯示於地圖與資訊卡]

